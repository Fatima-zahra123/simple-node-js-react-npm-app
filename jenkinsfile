pipeline {
    agent any

    environment {
        ARTIFACTS_DIR = "/var/jenkins_home/artifacts"
    }

    stages {
        stage('Check Environment') {
            steps {
                script {
                    sh 'echo "üìç R√©pertoire actuel : $(pwd)"'
                    sh 'ls -l || echo "‚ö†Ô∏è Impossible de lister le contenu"'
                }
            }
        }

        stage('Build') {
            steps {
                script {
                    if (fileExists('package.json')) {
                        echo "üöÄ D√©tection d'un projet Node.js, lancement de la build..."
                        sh 'npm install'
                        sh 'npm run build'
                        env.BUILD_DIR = 'build'   // ‚úÖ Correction ici
                    } else if (fileExists('pom.xml')) {
                        echo "üöÄ D√©tection d'un projet Maven (Spring Boot), lancement de la build..."
                        sh 'mvn clean package'
                        env.BUILD_DIR = 'target'
                    } else {
                        error "‚ùå Aucune build d√©tect√©e (ni package.json, ni pom.xml)."
                    }
                }
            }
        }

        stage('Verify Build Output') {
            steps {
                script {
                    if (!fileExists(env.BUILD_DIR) || sh(script: "ls -A ${env.BUILD_DIR} | wc -l", returnStdout: true).trim() == "0") {
                        error "‚ùå Aucun fichier g√©n√©r√© dans ${env.BUILD_DIR}. V√©rifiez votre build."
                    }
                }
            }
        }

        stage('Copy Artifacts') {
            steps {
                script {
                    sh "mkdir -p ${ARTIFACTS_DIR}"
                    sh "cp -r ${env.BUILD_DIR}/* ${ARTIFACTS_DIR}/"
                    echo "‚úÖ Copie termin√©e avec succ√®s !"
                }
            }
        }
    }

    post {
        failure {
            echo "‚ùå √âchec du pipeline, v√©rifiez les logs."
        }
        success {
            echo "üéâ Pipeline termin√© avec succ√®s !"
        }
    }
}
